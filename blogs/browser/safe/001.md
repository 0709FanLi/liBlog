---
title: XSS和CSRF攻击
date: 2021-09-22
tags:
  - browser
categories:
  - browser
sidebar: "auto"
---

记录学习 XSS 和 CSRF 攻击原理和防御。

## 什么是 XSS 攻击

XSS(cross site scripting)即跨站脚本攻击，为了不和 CSS 重名，故为 XSS。是指浏览器执行恶意脚本（无论是同域还是跨域），拿到用户信息进行一些操作。

大致可以做到这些事情

1. 窃取 cookie
2. 监听用户行为，直接发动到黑客服务器
3. 修改 dom 伪造登录表单
4. 在页面生成悬浮窗广告

通常情况下 XSS 攻击大致可以分为三类：

### 存储型

存储是指将恶意脚本存储到了服务器，比如说文章的评论添加了恶意的脚本代码，这段代码存储到了数据库，每次打开页面都会执行恶意脚本的代码，这就是存储型 xss 攻击。

### 反射型

`反射型XSS`指的是恶意请求作为网络请求中的一部分
比如我输入

```
http://sanyuan.com?q=<script>alert("你完蛋了")</script>
```

这样，在服务器拿到 q 参数，然后将其余的返回给前端，前端将这些内容当做 html 解析发现是一个脚本，直接执行了，这样就被攻击了。

之所以叫它反射型。是说恶意脚本作为参数发送到服务器，服务器返回当前参数，参数在前端被解析执行。
和存储型不一样的是，恶意脚本并不会存储到服务器

### 文档型

是指劫持网络数据直接修改 HTML 文档，并不会经过服务端，这样的劫持方式包括`本地恶意软件`和`运营商劫持`

## 怎样规避 XSS 攻击

### 一个信念

不行新用户的任何输入，无论是前端还是后端都要对用户的输入进行转码和过滤。

```
<script>alert('你完蛋了')</script>
```

转码后

```
&lt;script&gt;alert(&#39;你完蛋了&#39;)&lt;/script&gt;
```

或者采用关键字过滤的方式直接将恶意脚本删除。

### 利用 CSP

即是浏览器中的安全策略，它的核心思想就是限制加载哪些资源，具体来说就是：

1. 限制其它域下的资源加载
2. 禁止向其它域提交数据
3. 提供上报机制，能帮助我们及时发现 XSS 攻击。

### 利用 HttpOnly

很多 XSS 脚本都是通过`获取cookie`来达到攻击的目的，使用 HttpOnly 之后就不能通过脚本来获取 cookie 从而达到防御的目的。

## 总结

XSS 是用户故意植入脚本并在页面中执行，拿到用户信息进行操作，主要分为`存储型`、`反射型`和`文档型`

防御的措施包括：
· 一个信念：不相信用户的任何输入，将输入进行`转码`或`过滤`。
· 利用 CSP 对加载的资源或者可访问的网站进行限制
· 利用 HttpOnly 不能通过脚本获取 cookie

## CSRF

### 什么是 CSRF？

CSRF(Cross-site request forgery)即跨站请求伪造。是指诱导点击黑客的网站，打开黑客的网站，利用用户目前的`登录状态`发起跨站请求。

举个例子，你深夜打开了一个不知名网站，点击了一个经过黑客精心挑选的小姐姐的图片，那么恭喜你你被攻击了！

发生了什么？

可能会做三种事情：

### 自动发 get 请求

黑客网页有这样一段代码

```
<img src="https://xxx.com/info?user=hhh&count=100">
```

当图片加载的时候，可能已经向你曾经登陆过的网站发送请求了，恐怖的是这个请求是可以携带 cookie 的，这个请求可以是汇款转账之类的。

### 自动发 POST 请求

黑客可能自己填了一个表单，写了一段自动提交的脚本

```
<form id='hacker-form' action="https://xxx.com/info" method="POST">
  <input type="hidden" name="user" value="hhh" />
  <input type="hidden" name="count" value="100" />
</form>
<script>document.getElementById('hacker-form').submit();</script>
```

这同样会携带 cookie 信息，让误以为是正常的请求，从而让恶意操作变为可能。

### 诱导点击 GET 请求

黑客网站上可能会放一个诱导链接，比如

```
<a href="https://xxx/info?user=hhh&count=100" taget="_blank">点击进入修仙世界</a>
```

点击后自动发 get 请求，接下来的原理和自动发 get 请求相同。

这就是 CSRF 攻击的原理，

1. 诱导点击进入黑客网站
2. 利用**用户的已登录状态**和**服务器的验证漏洞**来`模拟用户进行操作`

想一想可以利用 XSS 攻击的防御方式吗？转码过滤？CSP? HttpOnly?，好像都不行，因为 XSS 的防御方式都是针对本网站的，现在是要防止已登录网站的登录信息被窃取，怎么进行防御呢？

## CSRF 防范措施

### 1. 利用 Cookie 的 SimeSite 属性

CSRF 重要的一环就是窃已登录网站的 Cookie，因此在 Cookie 上做文章是防范的不二之选。

恰好在 Cookie 中有这样一个字段，可以对携带 Cookie 做限制这个字段就是`SameSite`

`SameSite`可以设置三个属性，`Strict`、`Lax`和`None`

1. 在`Strict`模式下，浏览器完全禁止第三方请求携带 Cookie，比如说 `www.xxx.com`,只有在当前域名当中才能携带 Cookie，其它网站下的请求都不可以，
2. 在`Lax`就稍微宽松一点，但是只能在`get请求方法中`和`a链接请求`的情况下才能携带 cookie，其它情况均不能
3. 在`None`模式下，也就是默认模式下，会自动携带 Cookie

### 验证来源站点

就需要用到请求头中的两个字段：`Origin`和`Referer`
其中`Origin`只包含了域名信息，`Referer`包含了具体的 URL 路径
当然这两者都是可以伪造的，自定义请求头即可，安全性略差

### CSRF Token

浏览器向服务器发送请求时，服务器会返回一个字符串，返回到前端。

然后浏览器要发送请求就必须携带这个字符串，来验证请求是否合法，通常这个字符串其它网站是拿不到的，所以会被拒绝，这个字符串就是 CSRF Token。笔者所在的公司做的项目也有这个 token，只是不知道原来这个叫 CSRF Token，不知道是用来防御 CSRF 攻击的，这就。。。。

### CSRF 总结

CSRF(Cross-site request forgery)跨站请求伪造。指的是诱导用户点击黑客链接，打开页面，利用用户其它页面已登录的状态，获取用户信息伪造请求从而达到攻击的目的。

一般主要有三种攻击方式：

1. 自动发 GET
2. POST 请求
3. 诱导发送 get 请求

防御措施：

1. 利用`Cookie`的`SameSite`属性
2. 利用`Origin`和`Referer`
3. 利用`CSRF Token`

本篇文章记录了学习 XSS 和 CSRF 攻击的原理和防御的方法，忘了可以来这看看，😋。

水平有限，难免有错误之处，欢迎指出。

这篇记录来源[三元大佬的灵魂之问系列](https://juejin.cn/post/6844904021308735502#heading-67),推荐去阅读原文。
