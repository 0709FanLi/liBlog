---
title: å¼‚æ­¥æ–¹æ³•
date: 2021-09-01
tags:
  - åŸºç¡€
categories:
  - javascript
sidebar: "auto"
---

## Genertor å‡½æ•°

æ¯”è¾ƒå®¹æ˜“è¿·æƒ‘çš„ç‚¹ï¼š

```
function *foo(x) {
    let y = 2 * (yield (x + 1))
    let z = yield (y / 3)
    return (x + y + z)
}
let it = foo(5)
console.log(it.next())   // => {value: 6, done: false}
console.log(it.next(12)) // => {value: 8, done: false}
console.log(it.next(13)) // => {value: 42, done: true}
```

- let it = foo(5)
  è¿”å›ä¸€ä¸ªè¿­ä»£å™¨
- console.log(it.next())
  å‡½æ•°æš‚åœåœ¨`yield (x + 1)`,è¿”å› 5+1 ç­‰äº 6
- console.log(it.next(12))
  ä¼ å‚ 12ï¼Œä¸Šä¸€ä¸ª yield çš„è¿”å›å€¼ä¸º 12ï¼Œ`let y = 2 * 12`,æ‰€ä»¥ value = 8
- console.log(it.next(13))
  æ‰§è¡Œåˆ°è¿™ä¸€æ­¥æ—¶, `z = 13`,x+y+z = 5+24+13 = 42;

### Genertor thunk ç‰ˆæœ¬å¼‚æ­¥

- ä»€ä¹ˆæ˜¯ thunk å‡½æ•°ï¼Ÿ
  æ¯”å¦‚è¯´ï¼š

```
function isType(type) {
    return (val)=>{
        return Object.prototype.toString.call(val) === `[object ${type}]`
    }
}
let isString = isType('String');
let isNumber = isType('Number');
console.log(isString('abc'));
console.log(isNumber(123));
```

isType è¿™æ ·çš„å‡½æ•°æˆ‘ä»¬ç§°ä¹‹ä¸º thunk å‡½æ•°ï¼Œæ ¹æ®ç‰¹å®šéœ€æ±‚ï¼Œè¿”å›å®šåˆ¶åŒ–çš„å‡½æ•°ï¼Œå»å®Œæˆç‰¹å®šçš„åŠŸèƒ½ã€‚

ä»¥æ–‡ä»¶æ“ä½œä¸ºä¾‹ï¼Œçœ‹ Genertor å¦‚ä½•ç”¨äºå¼‚æ­¥ï¼Œ

```
function readTunnk(fileName) {
    return (callback)=>{
        fs.readFile(fileName, callback)
    }
}
```

readTunnk æ˜¯ä¸€ä¸ª thunk å‡½æ•°ï¼Œç›®çš„æ˜¯ä¸ºè¯»å†™çš„æ¯ä¸€ä¸ªæ–‡ä»¶ç»‘å®šå®šåˆ¶åŒ–å›è°ƒå‡½æ•°ï¼Œå¼‚æ­¥çš„æ ¸å¿ƒä¸€ç¯å°±æ˜¯ç»‘å®šå›è°ƒå‡½æ•°ï¼Œè¿™æ ·å°±æ˜¯`Genertor`å’Œ`å¼‚æ­¥`å…³è”èµ·æ¥äº†ã€‚`next`æ‰§è¡Œæœºåˆ¶ä½¿`thunk`å‡½æ•°è¿”å›äº†å®šåˆ¶åŒ–å‡½æ•°ï¼Œå¹¶ç»‘å®šåœ¨`next`çš„æ‰§è¡Œç»“æœé‡Œè¾¹ï¼Œè¿™æ ·å…³è”èµ·æ¥ã€‚

ç„¶å‡½æ•°å®Œæ•´çš„æ‰§è¡Œä¸‹

```
const gen =  function* (params) {
    let file1 = yield readTunnk('001.txt');
    console.log(file1.toString());
    let file2 = yield readTunnk('002.txt');
    console.log(file2.toString());
}

let g = gen();
/*
    ç¬¬ä¸€æ­¥è°ƒç”¨next,å¼€å§‹æ‰§è¡Œ,nextè¿”å›çš„valueæ˜¯ä¸€ä¸ªå®šåˆ¶åŒ–çš„å‡½æ•°ï¼Œ
    éœ€è¦ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œåº§ä½è¯»å–æ–‡ä»¶åçš„å›è°ƒå‡½æ•°
    ç¬¬äºŒæ­¥ï¼Œä¼ é€’data1ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œç¨‹åºç»§ç»­æ‰§è¡Œ
    ç¬¬ä¸‰æ­¥ï¼ŒåŒç†data2ä½œä¸ºå‚æ•°ä¼ å…¥
*/
g.next().value((err, data1)=>{
    g.next(data1).value((err,data2)=>{
        g.next(data2);
    })
})
```

æ‰“å°ç»“æœå¦‚ä¸‹

```
001.txtçš„å†…å®¹
002.txtçš„å†…å®¹
```

å¦‚æœå¤šå±‚åµŒå¥—ä¸Šè¾¹çš„å°±ä¼šå¾ˆå¤æ‚ï¼Œå°è£…ä¸‹ä»£ç 

```
/*
    å¦‚æœres.done == false
    å°±éœ€è¦å†æ¬¡è°ƒç”¨next
    ç›´åˆ° res.done == trueï¼Œ
    è¿™ä¸å°±æ˜¯è¿­ä»£å—
*/
const runGen = function (g) {
    const next = function (err,data) {
        const res = g.next(data);
        if(res.done) return;
        res.value(next);
    }
}
runGen(gen());
```

è¿™å°±æ˜¯`thunk`å‡½æ•°çš„ Genertor å¼‚æ­¥ç‰ˆæœ¬ã€‚Promise å½“ç„¶ä¹Ÿå¯ä»¥å®ç°ï¼Œæ€ä¹ˆå®ç°å‘¢ï¼Ÿ

### Genertor Promise ç‰ˆæœ¬å¼‚æ­¥

åŸç†åŸºæœ¬ä¸Šä¸€æ ·çš„

```
const promiseGen = function (str) {
    return new Promise((resolve,reject)=>{
        setTimeout(() => {
            resolve(str);
        }, 1000);
    })
}

const gen = function* () {
    let str1 = yield promiseGen('abc');
    console.log(str1);
    let str2 = yield promiseGen('def');
    console.log(str2);
};
```

`promiseGen`å‡½æ•°ï¼Œæˆ‘ä»¬æ¨¡æ‹Ÿå¼‚æ­¥ä¸€ç§’åå†³è®®`str`,æ˜¯ä¸æ˜¯å’Œ thunk å‡½æ•°æœ‰ç‚¹åƒï¼Œæ‰§è¡Œ thunk å‡½æ•°è¿”å›ä¸€ä¸ªå®šåˆ¶åŒ–å‡½æ•°ï¼Œæ‰§è¡Œ promiseGen è¿”å›ä¸€ä¸ªç‰¹å®šçš„ promise,åªä¸è¿‡æ˜¯å†™æ³•å°‘æœ‰ä¸åŒï¼Œ

çœ‹ä¸‹æ‰§è¡Œï¼Œ

```
let g = gen();
//  g.next().valueç­‰äºå®šåˆ¶åŒ–promise ç„¶åè°ƒç”¨then
//  return g.next(str1).value æ‹¿åˆ° 'abc'ç„¶åä¼ å‚ç»™ä¸‹ä¸€ä¸ª yield
g.next().value
.then(str1=>{
    return g.next(str1).value
})
.then(str2=>{
    return g.next(str2)
})
```

æŸ¥çœ‹è¾“å‡º

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/033baa2028164908a583ee9f60daaf23~tplv-k3u1fbpfcp-watermark.image)

ä¸€ç§’åæ‰“å°å‡ºäº†`abc`,éš”ä¸€ç§’æ‰“å°å‡ºäº†`def`

promise ç‰ˆæœ¬è¿˜æ˜¯å­˜åœ¨åµŒå¥—è¿‡å¤šçš„é—®é¢˜ï¼Œå†æ¥å°è£…ï¼Œå’Œ`thunkå‡½æ•°å°è£…åŸºæœ¬ä¸€æ ·`

```
let g = gen();
const runGen = function (g) {
    const next = function(data){
        const res = g.next(data);
        if(res.done) return;
        res.value.then((data2)=>{
            next(data2)
        })
    }
    next();
};
runGen(g);
```

### é‡‡ç”¨ co åº“

æˆ‘ä»¬é’ˆå¯¹`thunkå‡½æ•°`å’Œ`promise`ä¸¤ç§`Genertorå¼‚æ­¥æ“ä½œ`çš„ä¸€æ¬¡æ€§æ‰§è¡Œåšäº†å°è£…ï¼Œä½†å®é™…åœºæ™¯å·²ç»æœ‰äº†æˆç†Ÿçš„å·¥å…·åŒ…ï¼Œå°±æ˜¯`co`åº“ï¼Œå…¶æ ¸å¿ƒä»£ç æˆ‘ä»¬å·²ç»å†™è¿‡äº†ï¼Œåªä¸è¿‡æºç ä¼šå¯¹å„ç§è¾¹ç•Œæƒ…å†µåšå¤„ç†ï¼Œé£Ÿç”¨æ–¹æ³•ï¼š

```
const co = require('co');
let g = gen();
co(g).then(res =>{
    console.log(res);
})
```

å¥½äº†å·²ç»å®Œæˆäº†ï¼ŒçœŸä¸æ„§æ˜¯å¤©ç”Ÿä¸€å¯¹ã€‚

#### async/await

`async/await`è¢«ç§°ä¸ºå¼‚æ­¥çš„ç»ˆæè§£å†³æ–¹æ¡ˆï¼Œæ¥çœ‹ä¸‹ç”¨æ³•

```
const promiseGen = function (str) {
    return new Promise((resolve,reject)=>{
        setTimeout(() => {
            resolve(str);
        }, 1000);
    })
}

async function logFunc(params) {
    const str1 = await promiseGen('abc');
    console.log(str1);
    const str2 = await promiseGen('def');
    console.log(str2);
}

logFunc();
```

çœ‹ä¸‹è¾“å‡º

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7702cbeb33c044598be6cb50da9d37f5~tplv-k3u1fbpfcp-watermark.image)

çœŸä¸æ„§æ˜¯ç»ˆæè§£å†³æ–¹æ¡ˆï¼Œæ²¡æœ‰é‚£ä¹ˆå¤šå°è£…ï¼Œè€Œä¸”ä¹¦å†™æ ¼å¼ç¬¦åˆäººä»¬å¤§è„‘çš„æ€è€ƒæ–¹å¼åŒæ­¥è¿è¡Œï¼ŒçœŸçš„æ˜¯å‰å®³ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬æ·±å…¥ä¸€ç‚¹ï¼Œæœ‰æ²¡æœ‰å‘ç°è¿™ä¸ªå’Œæˆ‘ä»¬å®ç°çš„è‡ªæ‰§è¡Œçš„ Genertor å‡½æ•°æœ‰ç‚¹åƒ

```
runGen å’Œ yield
```

å®é™…ä¸Š`asyncå’Œawait`å°±æ˜¯ä¸Šè¾¹æˆ‘ä»¬å¯¹`Genertor`çš„å°è£…ï¼Œæ˜¯ä¸€ä¸ªè¯­æ³•ç³–ï¼›

å‚è€ƒæ–‡ç« ï¼š

- [å‰ç«¯é¢è¯•ä¹‹é“](https://juejin.cn/book/6844733763675488269/section/6844733763763568647)
- [åŸç”Ÿ JS çµé­‚ä¹‹é—®(ä¸‹), å†²åˆº ğŸš€ è¿›é˜¶æœ€åä¸€å…¬é‡Œ(é™„ä¸ªäººæˆé•¿ç»éªŒåˆ†äº«)](https://juejin.cn/post/6844904004007247880#heading-55)
- [Promise/async/Generator å®ç°åŸç†è§£æ](https://juejin.cn/post/6844904096525189128#heading-16)
